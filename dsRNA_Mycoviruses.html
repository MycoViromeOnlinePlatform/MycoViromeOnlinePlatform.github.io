<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dsRNA Mycoviruses Information</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/style.css">
    <style>
        /* Page styles */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
            color: #2d2d2d;
        }
        h1, h2, h3 {
            color: #155e3b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        p {
            margin-bottom: 10px;
        }
        
          /* Visualizer styles */
        #sequence-alignment-visualization { margin-top: 18px; }
        #controls { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
        #container { border:1px solid #ccc; width:100%; height:520px; overflow:auto; position:relative; background:white; }
        canvas { display:block; }
        textarea { width:100%; height:120px; font-family: monospace; }
        label { font-size: 14px; }
        .small { font-size: 13px; color:#555; }
        #tooltip { position: absolute; pointer-events: none; background: rgba(0,0,0,0.8); color: white; padding:6px 8px; font-size: 12px; border-radius:4px; display:none; z-index:10; }
        #legend { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .swatch { display:inline-flex; align-items:center; gap:6px; padding:4px 6px; border-radius:4px; background:#f6f6f6; border:1px solid #eee; }
        .dot { width:14px; height:14px; border-radius:2px; display:inline-block; }
        section { margin-bottom:18px; }
    </style>
</head>
<body>
    <h1>dsRNA Mycoviruses</h1>

    <p><strong>dsRNA mycoviruses</strong> represent a diverse group of viruses that specifically infect fungi, playing crucial roles in fungal biology and potentially in biological control strategies. Unlike most plant and animal viruses, mycoviruses generally lack an extracellular stage and are primarily transmitted intracellularly through hyphal fusion (anastomosis), cell division, and sporulation.</p>

    <p>The families listed&mdash;<em>Birnaviridae</em>, <em>Botybirnaviridae</em>, <em>Curvulaviridae</em>, <em>Endornaviridae</em>, <em>Fusagraviridae</em>, <em>Partitiviridae</em>, <em>Pseudototiviridae</em>, <em>Quadriviridae</em>, and <em>Totiviridae</em>&mdash;comprise a significant portion of known dsRNA mycoviruses, each with distinct genomic structures and characteristics.</p>

    <h2>Key Families and characteristics</h2>

    <table>
        <thead>
            <tr>
                <th>Family</th>
                <th>Genome Structure</th>
                <th>Key Characteristics</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Totiviridae</strong></td>
                <td>Monopartite dsRNA</td>
                <td>Among the simplest dsRNA viruses, often found in <em>Saccharomyces cerevisiae</em>.</td>
            </tr>
            <tr>
                <td><strong>Partitiviridae</strong></td>
                <td>Bipartite dsRNA</td>
                <td>The genome consists of two segments. This family includes both fungal and plant viruses.</td>
            </tr>
            <tr>
                <td><strong>Quadriviridae</strong></td>
                <td>Quadripartite dsRNA</td>
                <td>Contains four linear dsRNA segments.</td>
            </tr>
            <tr>
                <td><strong>Birnaviridae</strong></td>
                <td>Bisegmented dsRNA</td>
                <td>Non-enveloped, with a T=13 icosahedral capsid, primarily known to infect vertebrates and insects, but some members have fungal hosts.</td>
            </tr>
            <tr>
                <td><strong>Endornaviridae</strong></td>
                <td>Monopartite positive-sense ssRNA (with dsRNA replication intermediates)</td>
                <td>These viruses are unusual as they lack a true virion capsid and are chronic, often symptomless, infections in plants, fungi, and oomycetes.</td>
            </tr>
            <tr>
                <td><em><strong>Botybirnaviridae</strong></em>, <em><strong>Curvulaviridae</strong></em>, <em><strong>Fusagraviridae</strong></em>, <em><strong>Pseudototiviridae</strong></em></td>
                <td>Various dsRNA structures</td>
                <td>These are more recently recognized or less studied families, highlighting the expanding diversity of the fungal virome discovered through modern techniques like next-generation sequencing.</td>
            </tr>
        </tbody>
    </table>

    <h2>Ecological significance and impact</h2>

    <p>The impact of these mycoviruses on their fungal hosts is highly variable. Many infections are <strong>cryptic</strong>, meaning they produce no obvious symptoms. However, some viruses induce significant phenotypic changes, such as altered pigmentation, reduced growth, and modified sporulation.</p>

    <p>Of particular interest to agriculture is the phenomenon of <strong>hypovirulence</strong>, where a viral infection reduces the ability of a pathogenic fungus to cause disease in plants. For example, viruses in families like <em>Partitiviridae</em> and others have been found to attenuate the virulence of serious plant pathogens like <em>Rhizoctonia solani</em> and <em>Fusarium graminearum</em>. This has led to ongoing research into engineering mycoviruses as potential <strong>biocontrol agents</strong> to manage fungal diseases in crops.</p>

    <p>The main challenge for their use as biocontrol agents is their limited natural transmission, often restricted by fungal vegetative incompatibility barriers, a research area where ongoing studies are exploring solutions.</p>

    <!-- Sequence Alignment Visualization section (embedded visualizer) -->
    <section id="sequence-alignment-visualization" aria-labelledby="sav-heading">
      <h2 id="sav-heading">Sequence Alignment Visualization</h3>

      <div id="controls">
        <input id="fileInput" type="file" accept=".fa,.fasta,.txt" />
        <button id="loadSample">Load sample MSA</button>
        <label class="small">Cell size:
          <input id="cellSize" type="range" min="6" max="28" value="14" />
        </label>
        <label class="small">Show letters:
          <input id="showLetters" type="checkbox" checked />
        </label>
        <label class="small">Color scheme:
          <select id="colorScheme">
            <option value="bases">By base (A/C/G/T)</option>
            <option value="identity">Identity to reference (row 0)</option>
          </select>
        </label>
        <button id="pasteAreaToggle">Toggle paste area</button>
      </div>

      <div id="pasteArea" style="display:none; margin-bottom:8px;">
        <div class="small">Paste an aligned FASTA (equal-length sequences) and click "Render":</div>
        <textarea id="fastaText"></textarea>
        <div style="margin-top:6px;">
          <button id="renderFromText">Render pasted FASTA</button>
        </div>
      </div>

      <div id="container" aria-live="polite">
        <canvas id="msaCanvas"></canvas>
        <div id="tooltip" role="status" aria-hidden="true"></div>
      </div>

      <div id="legend" aria-hidden="false">
        <div class="swatch"><span class="dot" id="colA"></span>A</div>
        <div class="swatch"><span class="dot" id="colC"></span>C</div>
        <div class="swatch"><span class="dot" id="colG"></span>G</div>
        <div class="swatch"><span class="dot" id="colT"></span>T</div>
        <div class="swatch"><span class="dot" id="colDash"></span>Gap (-)</div>
        <div style="margin-left:12px;" class="small">Hover to inspect a cell. Labels are shown on the left. Use file upload or paste FASTA. Zoom via cell size.</div>
      </div>
    </section>

    <script>
		
      // Minimal MSA visualizer (client-only) with labels on the left and integrated into the page.
      const canvas = document.getElementById('msaCanvas');
      const ctx = canvas.getContext('2d');
      const container = document.getElementById('container');
      const tooltip = document.getElementById('tooltip');

      const fileInput = document.getElementById('fileInput');
      const loadSample = document.getElementById('loadSample');
      const cellSizeInput = document.getElementById('cellSize');
      const showLettersCheckbox = document.getElementById('showLetters');
      const colorSchemeSelect = document.getElementById('colorScheme');
      const pasteToggle = document.getElementById('pasteAreaToggle');
      const pasteArea = document.getElementById('pasteArea');
      const fastaText = document.getElementById('fastaText');
      const renderFromText = document.getElementById('renderFromText');

      // Example small aligned FASTA (equal length)
      const sampleFASTA = `>lcl|consensus
----MWTWACTACYAYSTMCAAYYAMWCYAWMACYAACMMCAMC-----ACCATG-----
--------AACCRMTS-CCAYRAATWMAARNMACAAMMRNWRKNNTTTC----YRTNGCT
CYSNMGKCMARCAWMWGMMKMRWRAMWMTMKRWMRMGYYYYGAWRAWYWMAYMAAWAY--
--------RNAWMRMNNMAYTKATRMWAYKAMSRWY----MKYWTGAYAKYMRRWYWYWA
------------AYCSAWACYWMKMNNYWYT-----------------------------
---------TGASASNASMWNNWTMTRSSTYWYWTRKTGYMMNCA-TAMCAG--------
----------------------------------------------CAACMAMAMMYGYT
MSRAWGRRSMNKKGSYMACTTWMRSTAWSKANGWAMMAYNSMMAAANGAYMKNRWARRSC
G-------------------------TWAAWYARCKAGTGGNTKMNCYNAS---------
----------------ATTGKRWWATCRTYGGKAAC--------KAYAAKCCRGY--TKC
>gb|MN617758.1| [organism=Botrytis cinerea endornavirus 2] [isolate=BCI1_DN2153] [collection_date=2018]
----CATTACTACCATGTCTAACTACACCAAATCCAACGCCAAC-----ACCATG-----
--------AACCAATCACCACGAAACAAAATAACAAACATCATTGATTC----TGTTGCT
CTCGAGGCTAACAACAGAATCATGACTCTCGAAAAAGCCTCGAAAAACAAACAAAAACAA
CAAACAAAATCACAAGGAACTGATGAAATGGAGGTCAGCTCTCTTGGTAATAGATCTTTA
------------ACCCATACCACTGGCCACT-----------------------------
---------TGACACCACGAGCCTCTAACTCCAACAGCATCGACAGTAACAGCGT-----
----------------------------------------------CAACCACAACCGCT
ACAAGGGGCCTTTTGCTACTTTAGCTATGGATGAACCACTGCCAAGTGACCGGGTAGAGC
G-------------------------TGAGACAGCAACCGATTTCGCTGAC---------
----------------ATCGGATTGTCGTCGGGTAATTCT----GACAAAGCAAA--TGC
>gb|MN839443.1|organism=Botrytis cinerea endornavirus 3] [isolate=BCI11_DN9384] [geo_loc_name=Italy] [collection_date=2018]
--ACCACTACAACCATGTCCAACTACACCAAAACCAACACCAAC-----ACCATG-----
--------AACCAATCACCACGAAATAAAATAACAAACATTATTGATTC----TGTTGCT
CTCGAGGCTAACAACAGAATCATGACTCTCGAAAAAGCCTCGAAAAACAAACAAAAACAA
CAAACAAAAAATCAATTAATTGATGAAACTAAGGTCGATACACTTGACAGTCGATCTTTA
------------ACCCATACCACTAATCATT-----------------------------
---------TGACACAACCGCTTTCTGTCTTCGGTGGTGTTGACGGTAACAGCGT-----
----------------------------------------------CAACCACAACCGCT
ACAAAGGGCCGTTGGCCACTTTAGCTATGGACGAAACACCGCCACAAGACCGCGTGGAGC
G-------------------------TAACGCAGCGACTGATTTCGCTGAT---------
----------------ATTGAATTATCATCCAGTACACCT----GATAAGTCAAA--TGC
>gb|OL412282.1|[organism=Botrytis cinerea endornavirus 4] [isolate=Kst31] [[geo_loc_name=Pakistan] [collection_date=2018]
--ACCATTACTACCATGCCCCGCTACGTCAACAGCAACAATACCAGT-AACCATGGCCAA
CCAACAACAACCAAGC-AAACAAATTCAACAAACAACAAACAACCACAC-------TGCT
CCAGAGGCAGGCAGTGCGGTTGTGACACTCGAAGATGCCTCTACAATATTAACAAAACAA
CAACAACAAGAAAACAACACAAATAGTGCTACGAATGATAATTATGATAGCAATTTTAAG
CCTAAACACGTCACCCAGGCTAATACATATTCTGAGCTGTCATCTAGCAACACAATTGTT
GGTAACAAACGACACGACCAAGTTACGCGTAATTTGGTGCCAACG-CACCAG--------
---------GCTATCGGATTTGGTAAGGATGGCCTGGGCATCTATACTACAGCAACTGGT
TTCAAGGGACCATGTGCAACGCTTGTGAACAACAACAGTACAAAAACGTTAGATGATACC
ATGTCAGCAAGACCGCAGACGCCAGCTAAAAAACCGAGTGGTAGCACCAAAGTGCCAACA
AACTTTTCAGACATAGATTTGAGTAGTAGTGGCGACAACCTGCGAACAGGACAGT-----
>gb|KU923747.1| [organism=Botrytis cinerea betaendornavirus 1] [strain=HBtom-372][geo_loc_name=China] [collection_date=2013]
TATAATTAACTACTACCTACAATCAATCTATCACTAACCACACCAATCAACCATGTCTTA
CCA-----AACCGCTG-CCACAAATTCAAACAACAACAAGAGGAGTCTC-------GGCC
TCCTCCCTAAATATATGCCGAGAAAAAATATGTCGCGTTCTGATGATTTCATCAATAT--
--------GGATAGCGACATTTATACTATGACCAAT----AGTATGACATCCAGATACAA
TCAGCCCAAGATATCGAAACTTAGCACTTCTCTGAG------------------------
----AATAATGAGAGAAGATGTATATGGGCCACTTGGTGCAATTAGTACCAGAAGGAACC
ATGTGTATAAAGATTTGATATGCCATAAATGTCTTG---ATAAACACAACAAAACATGTT
CGGATGAAGATGGGCTAACTTACAGTAACTACGTAAAATACAAAAATGATATTAAAAGCC
G-------------------------CAAAACAATTGGTGGGTTTATCTACAAGTCTTAT
TTCCACTTGAAACTCGATTGTGAAATCATTGGTAAC--------TATAAGCCTGTCTTTC
>ref|NC_031752.1| [organism=Botrytis cinerea betaendornavirus 1] [strain=HBtom-372] [geo_loc_name=China] [collection_date=2013]
TATAATTAACTACTACCTACAATCAATCTATCACTAACCACACCAATCAACCATGTCTTA
CCA-----AACCGCTG-CCACAAATTCAAACAACAACAAGAGGAGTCTC-------GGCC
TCCTCCCTAAATATATGCCGAGAAAAAATATGTCGCGTTCTGATGATTTCATCAATAT--
--------GGATAGCGACATTTATACTATGACCAAT----AGTATGACATCCAGATACAA
TCAGCCCAAGATATCGAAACTTAGCACTTCTCTGAG------------------------
----AATAATGAGAGAAGATGTATATGGGCCACTTGGTGCAATTAGTACCAGAAGGAACC
ATGTGTATAAAGATTTGATATGCCATAAATGTCTTG---ATAAACACAACAAAACATGTT
CGGATGAAGATGGGCTAACTTACAGTAACTACGTAAAATACAAAAATGATATTAAAAGCC
G-------------------------CAAAACAATTGGTGGGTTTATCTACAAGTCTTAT
TTCCACTTGAAACTCGATTGTGAAATCATTGGTAAC--------TATAAGCCTGTCTTTC
>gb|PV443068.1|[organism=Botrytis cinerea betaendornavirus 5] [isolate=IBc-374][geo_loc_name=Israel] [collection_date=2019]
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
-------------------------------------TGCAAGCA---------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
--------------------------TATTGGAAAT--------TATAAGCCAGTGTTTC
>gb|OR161976.1| [organism=Botrytis cinerea botybirnavirus 3] [isolate=BcBV3] [geo_loc_name=Pakistan] [collection_date=2018/2019]
------------------------------------------------------------
--------------------GCAATAAAAAGCACAGCCGGAAGGCTTTC----TTTT---
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
--------------------------------------------TATTGCCCAGT-----
>gb|KJ549662.1| [organism=Botrytis cinerea RNA virus 1] [strain=BerBc-1][geo_loc_name=China: Wuhan, Hubei] [collection_date=2008] 
------------------------------------------------------------
--------------------TGAATAAAAGGCCGAAAGGCTGGATTTTCAGAGCATCGCT
CCGAAGTCCAGC------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
-------------------------TACCTTTTATATTGTCCAC----------------
------------------------------------------------------------
------------------------------------------------------------
--------------------------TTAATTAGCTAGTGGATGATCTCAG---------
---------------------------GTCGGGA----------GACAATCCGGC----C
>gb|MN443879.1|[organism=Botrytis cinerea RNA virus 1] [geo_loc_name=Colombia:Antioquia] [collection_date=2018]
------------------------------------------------------------
-------------------------------------------GATTTCTGGGGATTTCT
CTGGTGTCCAGC------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
-------------------------TACCTTTTATGTTACCCGC----------------
------------------------------------------------------------
------------------------------------------------------------
--------------------------TTAATTAGCTAGCGGTTAACCTCAG---------
---------------------------GTCGGGA----------GGCAATCCGGC----C
>ref|NC_026139.1|[organism=Botrytis cinerea RNA virus 1] [strain=BerBc-1] [geo_loc_name=China: Wuhan, Hubei] [collection_date=2008]
------------------------------------------------------------
--------------------TGAATAAAAGGCCGAAAGGCTGGATTTTCAGAGCATCGCT
CCGAAGTCCAGC------------------------------------------------
------------------------------------------------------------
------------------------------------------------------------
-------------------------TACCTTTTATATTGTCCAC----------------
------------------------------------------------------------
------------------------------------------------------------
--------------------------TTAATTAGCTAGTGGATGATCTCAG---------
---------------------------GTCGGGA----------GACAATCCGGC----C`;
      // Color maps (simple)
      const baseColors = {
        A: '#1f77b4', // blue
        C: '#2ca02c', // green
        G: '#ff7f0e', // orange
        T: '#d62728', // red
        U: '#9467bd', // purple (RNA)
        N: '#7f7f7f', // gray
        '-': '#f2f2f2' // gap light
      };

      // Fill legend swatches
      document.getElementById('colA').style.background = baseColors.A;
      document.getElementById('colC').style.background = baseColors.C;
      document.getElementById('colG').style.background = baseColors.G;
      document.getElementById('colT').style.background = baseColors.T;
      document.getElementById('colDash').style.background = baseColors['-'];

      let msa = { ids: [], seqs: [] }; // current alignment
      let cellSize = parseInt(cellSizeInput.value, 10);
      let showLetters = showLettersCheckbox.checked;
      let colorScheme = colorSchemeSelect.value;

      // store the computed left margin used in the last render (CSS pixels)
      let currentLeftMargin = 80;

      function parseFasta(text) {
        const lines = text.split(/\r?\n/);
        const ids = [];
        const seqs = [];
        let curId = null;
        let curSeq = [];
        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          if (line.startsWith('>')) {
            if (curId !== null) {
              ids.push(curId);
              seqs.push(curSeq.join('').toUpperCase());
            }
            curId = line.substring(1).trim() || `seq${ids.length+1}`;
            curSeq = [];
          } else {
            curSeq.push(line.replace(/\s+/g, ''));
          }
        }
        if (curId !== null) {
          ids.push(curId);
          seqs.push(curSeq.join('').toUpperCase());
        }
        return { ids, seqs };
      }

      function validateMSA(parsed) {
        if (!parsed.ids.length) return 'No sequences found in FASTA.';
        const len0 = parsed.seqs[0].length;
        for (let i=0;i<parsed.seqs.length;i++) {
          if (parsed.seqs[i].length !== len0) {
            return `Sequence lengths differ: sequence ${i} length ${parsed.seqs[i].length} != ${len0}. Please provide aligned sequences of equal length.`;
          }
        }
        return null;
      }

      function computeLeftMargin(fontSize) {
        // Use an offscreen canvas to measure text width in CSS pixels
        const measureCtx = document.createElement('canvas').getContext('2d');
        measureCtx.font = `${fontSize}px sans-serif`;
        let maxW = 0;
        for (let id of msa.ids) {
          const w = measureCtx.measureText(id).width;
          if (w > maxW) maxW = w;
        }
        const min = 60;
        return Math.max(min, Math.ceil(maxW + 16)); // padding to the right
      }

      function render() {
        if (!msa.ids.length) {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          return;
        }
        const rows = msa.seqs.length;
        const cols = msa.seqs[0].length;

        cellSize = parseInt(cellSizeInput.value,10);
        showLetters = showLettersCheckbox.checked;
        colorScheme = colorSchemeSelect.value;

        const cellW = cellSize;
        const cellH = Math.max(18, Math.round(cellSize * 1.1));
        const rulerHeight = 22;

        // compute left margin based on label font size
        const labelFontSize = Math.max(12, cellSize - 2);
        const leftMargin = computeLeftMargin(labelFontSize);
        currentLeftMargin = leftMargin;

        const colsWidth = cols * cellW;
        const canvasCssWidth = leftMargin + colsWidth;
        const canvasCssHeight = rows * cellH + rulerHeight;

        // High-DPI handling
        const dpr = window.devicePixelRatio || 1;
        canvas.style.width = canvasCssWidth + 'px';
        canvas.style.height = canvasCssHeight + 'px';
        canvas.width = Math.max(1, Math.floor(canvasCssWidth * dpr));
        canvas.height = Math.max(1, Math.floor(canvasCssHeight * dpr));
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        ctx.clearRect(0,0,canvasCssWidth,canvasCssHeight);

        // Draw ruler area (shifted right by leftMargin)
        ctx.fillStyle = '#fafafa';
        ctx.fillRect(leftMargin, 0, colsWidth, rulerHeight);
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(leftMargin, rulerHeight-0.5);
        ctx.lineTo(leftMargin + colsWidth, rulerHeight-0.5);
        ctx.stroke();

        ctx.fillStyle = '#333';
        ctx.font = `${Math.max(10, cellSize-2)}px sans-serif`;
        ctx.textBaseline = 'middle';
        // draw tick labels every N positions depending on cell width
        const tickStep = cellW >= 12 ? 1 : Math.max(1, Math.ceil(10 / (cellW / 6)));
        for (let c = 0; c < cols; c++) {
          if ((c+1) % tickStep === 0) {
            const x = leftMargin + c * cellW + cellW/2;
            const txt = (c+1).toString();
            const w = ctx.measureText(txt).width;
            ctx.fillText(txt, x - (w/2), rulerHeight/2);
          }
        }

        // Draw left label background
        ctx.fillStyle = '#f8f8f8';
        ctx.fillRect(0, rulerHeight, leftMargin, rows * cellH);
        ctx.strokeStyle = '#eee';
        ctx.beginPath();
        ctx.moveTo(leftMargin - 0.5, rulerHeight);
        ctx.lineTo(leftMargin - 0.5, rulerHeight + rows * cellH);
        ctx.stroke();

        // Precompute reference row for identity coloring if chosen
        let refSeq = null;
        if (colorScheme === 'identity') {
          refSeq = msa.seqs[0]; // row 0 is reference
        }

        // Draw rows and cells
        ctx.font = `${Math.max(10, cellSize-2)}px monospace`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        for (let r = 0; r < rows; r++) {
          const y = rulerHeight + r * cellH;
          // optional alternating background
          if (r % 2 === 1) {
            ctx.fillStyle = '#fbfbfb';
            ctx.fillRect(leftMargin, y, colsWidth, cellH);
          }

          const seq = msa.seqs[r];
          for (let c = 0; c < cols; c++) {
            const base = seq[c] || 'N';
            let color;
            if (colorScheme === 'bases') {
              color = baseColors[base] || baseColors['N'];
            } else if (colorScheme === 'identity') {
              const refBase = (refSeq && refSeq[c]) ? refSeq[c] : null;
              color = (refBase && base === refBase) ? '#b6e6b6' : '#f6bdbd'; // greenish vs redish
            } else {
              color = baseColors[base] || baseColors['N'];
            }
            // Draw cell at shifted x
            const x = leftMargin + c * cellW;
            ctx.fillStyle = color;
            ctx.fillRect(x + 0.5, y + 0.5, cellW - 1, cellH - 1);

            // Draw letter if enabled and cell wide enough
            if (showLetters && cellW >= 8) {
              ctx.fillStyle = (base === '-' ? '#666' : 'white');
              if (color === '#f2f2f2') ctx.fillStyle = '#333';
              ctx.fillText(base, x + cellW/2, y + cellH/2 + 1);
            }
          }

          // Draw sequence id in the left margin (right-aligned)
          ctx.fillStyle = '#222';
          ctx.textAlign = 'right';
          ctx.font = `${labelFontSize}px sans-serif`;
          ctx.fillText(msa.ids[r], leftMargin - 8, y + cellH/2);
          ctx.textAlign = 'center';
        }
      }

      // Mouse interactions: show tooltip with id, position, base (account for left margin)
      container.addEventListener('mousemove', (ev) => {
        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const y = ev.clientY - rect.top;
        if (!msa.ids.length) {
          tooltip.style.display = 'none';
          tooltip.setAttribute('aria-hidden', 'true');
          return;
        }
        const cellW = cellSize;
        const cellH = Math.max(18, Math.round(cellSize * 1.1));
        const rulerHeight = 22;
        if (y < rulerHeight || x < currentLeftMargin) {
          tooltip.style.display = 'none';
          tooltip.setAttribute('aria-hidden', 'true');
          return;
        }
        const col = Math.floor((x - currentLeftMargin) / cellW);
        const row = Math.floor((y - rulerHeight) / cellH);
        if (row < 0 || row >= msa.seqs.length || col < 0 || col >= msa.seqs[0].length) {
          tooltip.style.display = 'none';
          tooltip.setAttribute('aria-hidden', 'true');
          return;
        }
        const base = msa.seqs[row][col] || 'N';
        tooltip.style.display = 'block';
        tooltip.setAttribute('aria-hidden', 'false');
        tooltip.style.left = (ev.clientX + 12) + 'px';
        tooltip.style.top = (ev.clientY + 12) + 'px';
        tooltip.innerHTML = `<strong>${msa.ids[row]}</strong><br>pos: ${col+1} &nbsp; base: <code>${base}</code>`;
      });

      container.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
        tooltip.setAttribute('aria-hidden', 'true');
      });

      // File upload handling
      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const parsed = parseFasta(text);
          const err = validateMSA(parsed);
          if (err) {
            alert(err);
            return;
          }
          msa = parsed;
          render();
          // scroll container to top-left
          container.scrollTo({ left: 0, top: 0 });
        };
        reader.readAsText(f);
      });

      // Paste area
      pasteToggle.addEventListener('click', () => {
        pasteArea.style.display = pasteArea.style.display === 'none' ? 'block' : 'none';
      });
      renderFromText.addEventListener('click', () => {
        const text = fastaText.value.trim();
        if (!text) { alert('Paste FASTA text first.'); return; }
        const parsed = parseFasta(text);
        const err = validateMSA(parsed);
        if (err) { alert(err); return; }
        msa = parsed;
        render();
        container.scrollTo({ left: 0, top: 0 });
      });

      // Load sample
      loadSample.addEventListener('click', () => {
        const parsed = parseFasta(sampleFASTA);
        const err = validateMSA(parsed);
        if (err) { alert(err); return; }
        msa = parsed;
        render();
        container.scrollTo({ left: 0, top: 0 });
      });

      // Controls changes
      cellSizeInput.addEventListener('input', () => {
        render();
      });
      showLettersCheckbox.addEventListener('change', render);
      colorSchemeSelect.addEventListener('change', render);

      // Initial load
      (() => {
        const parsed = parseFasta(sampleFASTA);
        const err = validateMSA(parsed);
        if (!err) {
          msa = parsed;
          render();
        }
      })();

      // Resize handling: re-render on container resize to ensure correct styles
      let resized;
      window.addEventListener('resize', () => {
        clearTimeout(resized);
        resized = setTimeout(render, 150);
      });
    </script>
<section id="Phylogeny" aria-labelledby="sav-heading">
<a href="https://auspice.us/" target="_blank">Evolution</a> <br></br>
</section>
<section id="References" aria-labelledby="sav-heading">
	<h2>References</h2>
</section>
</body>
</html>
